name: Voice Create Bot Publish
on:
  push:
    branches:
      - develop
jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      app_version: ${{ steps.semver.outputs.tag }}
      tag: ${{ steps.semver_release.outputs.tag }}
    steps:
    - name: semver
      uses: K-Phoen/semver-release-action@master
      with:
        release_strategy: none
        tag_format: '%major%.%minor%.%patch%'
        release_branch: master
        env:
          GITHUB_TOKEN: ${{ github.token }}
    - name: semver_release
      uses: K-Phoen/semver-release-action@master
      with:
        release_strategy: release
        tag_format: 'v%major%.%minor%.%patch%'
        release_branch: master
        env:
          GITHUB_TOKEN: ${{ github.token }}
  docker:
    runs-on: ubuntu-latest
    needs: version
    env:
      APP_VERSION: ${{ needs.version.outputs.app_version }}
      DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
    steps:
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1
    - name: Login to DockerHub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - name: Build and Push
      id: docker_build
      uses: docker/build-push-action@v2
      with:
        push: true
        tags: camalot/voice-create-bot-docker:latest
  merge:
    runs-on: ubuntu-latest
    needs: docker
    steps:
    - uses: actions/checkout@master
    - name: Merge develop -> master
      uses: devmasx/merge-branch@v1.3.1
      with:
        type: now
        from_branch: develop
        target_branch: master
        github_token: ${{ github.token }}
